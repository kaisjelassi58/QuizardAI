/**
 * Quizard AI â€“ Quiz Generator Core Script
 * ----------------------------------------
 * Pure JavaScript (browser-compatible, no dependencies).
 * Used as the embedded AI quiz generation engine inside the Quizard AI HTML app.
 *
 * Usage: include this script in the HTML or import its functions.
 *
 * Exports:
 *   - extractKeyPhrases(text, n) â†’ string[]
 *   - getSentences(text)         â†’ string[]
 *   - shuffle(arr)               â†’ array
 *   - generateQuiz(text, difficulty) â†’ QuizObject
 */

/**
 * Extract the top-N most frequent meaningful words from lesson text.
 * @param {string} text - Full lesson text
 * @param {number} n    - How many key phrases to return (default 15)
 * @returns {string[]}
 */
function extractKeyPhrases(text, n = 15) {
  const words = text.replace(/[^a-zA-Z0-9 ]/g, ' ').split(/\s+/).filter(w => w.length > 5);
  const freq = {};
  words.forEach(w => { const lw = w.toLowerCase(); freq[lw] = (freq[lw] || 0) + 1; });
  return Object.entries(freq).sort((a, b) => b[1] - a[1]).slice(0, n).map(e => e[0]);
}

/**
 * Split text into meaningful sentences (30â€“300 chars).
 * @param {string} text
 * @returns {string[]}
 */
function getSentences(text) {
  return text
    .split(/[.!?]+/)
    .map(s => s.trim())
    .filter(s => s.length > 30 && s.length < 300);
}

/**
 * Fisher-Yates shuffle (returns new array).
 * @param {any[]} arr
 * @returns {any[]}
 */
function shuffle(arr) {
  const a = [...arr];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

/**
 * Generate a 10-question quiz from lesson text.
 *
 * Quiz composition:
 *   - 5 Multiple Choice Questions (4 options each)
 *   - 3 True / False questions
 *   - 2 Short Answer questions
 *
 * All questions are derived exclusively from the provided lesson text.
 *
 * @param {string} text       - Extracted lesson text (min 50 chars)
 * @param {string} difficulty - 'easy' | 'medium' | 'hard'
 * @returns {{
 *   difficulty: string,
 *   generatedAt: string,
 *   questions: Array<{
 *     id: string,
 *     type: 'mcq' | 'tf' | 'short',
 *     question: string,
 *     options?: string[],      // MCQ only
 *     correct: string,         // MCQ & T/F
 *     sampleAnswer?: string,   // Short answer only
 *     explanation: string
 *   }>
 * }}
 */
function generateQuiz(text, difficulty = 'medium') {
  const sentences = getSentences(text);
  const phrases   = extractKeyPhrases(text);

  // Distractor pool for MCQ wrong options
  const distractorPool = [
    'None of the above',
    'All of the above',
    'Cannot be determined from the text',
    'It depends on context',
    'The opposite of what is stated',
    'A different process entirely',
    'An external factor not mentioned',
    'A theoretical construct only'
  ];

  /** Pick a random sentence not previously used */
  function pickSentence(excludeSet = new Set()) {
    const pool = sentences.filter((_, i) => !excludeSet.has(i));
    if (!pool.length) return sentences[0] || 'The main concept discussed.';
    return pool[Math.floor(Math.random() * pool.length)];
  }

  /** Truncate sentence based on difficulty */
  function truncate(s) {
    const len = difficulty === 'easy' ? 60 : difficulty === 'hard' ? s.length : 80;
    return s.length > len ? s.slice(0, len) + 'â€¦' : s;
  }

  /** Build 3 wrong options for an MCQ */
  function makeDistractors(correct, n = 3) {
    const pool = [
      ...distractorPool,
      ...phrases.slice(0, 5).map(p => `Related to "${p}" specifically`)
    ].filter(d => !d.toLowerCase().startsWith(correct.toLowerCase().slice(0, 8)));
    return shuffle(pool).slice(0, n);
  }

  const used = new Set();

  // â”€â”€ 5 MCQ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const mcqStems = [
    (s, p) => `According to the lesson, which statement best describes: "${truncate(s)}"?`,
    (s, p) => `Which of the following best summarizes: "${truncate(s)}"?`,
    (s, p) => `What is the primary focus when the text discusses "${p}"?`,
    (s)    => `Based on the lesson content, which statement is most accurate?`,
    (s, p) => `The lesson explains that which of the following relates to "${p}"?`,
  ];

  const mcqs = Array.from({ length: 5 }, (_, i) => {
    const s = pickSentence(used);
    const idx = sentences.indexOf(s);
    if (idx >= 0) used.add(idx);
    const phrase   = phrases[i] || 'the main topic';
    const correct  = truncate(s);
    const options  = shuffle([correct, ...makeDistractors(correct)]);
    return {
      id:          `mcq_${i}`,
      type:        'mcq',
      question:    mcqStems[i](s, phrase),
      options,
      correct,
      explanation: `The lesson directly states: "${s.slice(0, 120)}${s.length > 120 ? 'â€¦' : ''}"`
    };
  });

  // â”€â”€ 3 True/False â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const tfTemplates = [
    s => ({
      question:    `TRUE or FALSE: "${truncate(s)}" is stated in the lesson.`,
      correct:     'True',
      explanation: 'This statement is directly supported by the lesson content.'
    }),
    () => ({
      question:    `TRUE or FALSE: The lesson content implies that information about "${phrases[0] || 'the topic'}" is NOT discussed.`,
      correct:     'False',
      explanation: `The lesson does discuss this â€” the statement is false.`
    }),
    s => ({
      question:    `TRUE or FALSE: According to the text, "${truncate(s)}" is accurate.`,
      correct:     'True',
      explanation: 'This is confirmed by the lesson material.'
    }),
  ];

  const tfs = tfTemplates.map((tmpl, i) => {
    const s   = pickSentence(used);
    const idx = sentences.indexOf(s);
    if (idx >= 0) used.add(idx);
    return { id: `tf_${i}`, type: 'tf', ...tmpl(s) };
  });

  // â”€â”€ 2 Short Answer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const saStems = [
    p => `In your own words, briefly explain what the lesson says about "${p}".`,
    () => `What is the main idea the lesson conveys regarding "${phrases[1] || 'the subject'}"? Write 1â€“2 sentences.`,
  ];

  const shorts = saStems.map((stem, i) => {
    const phrase = phrases[i] || 'the main topic';
    const sample = pickSentence(used);
    return {
      id:           `sa_${i}`,
      type:         'short',
      question:     stem(phrase),
      sampleAnswer: sample,
      explanation:  `A good answer references the lesson's discussion of "${phrase}". Sample: "${sample.slice(0, 100)}â€¦"`
    };
  });

  return {
    difficulty:  { easy: 'Easy', medium: 'Medium', hard: 'Hard' }[difficulty] || 'Medium',
    generatedAt: new Date().toLocaleString(),
    questions:   shuffle([...mcqs, ...tfs, ...shorts])
  };
}

// Export for environments that support it (Node.js / bundlers)
if (typeof module !== 'undefined' && module.exports) {
  module.exports = { extractKeyPhrases, getSentences, shuffle, generateQuiz };
}